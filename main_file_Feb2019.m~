%*************************************************************************%
%    Main
%
%    NOTE describe variables (especially SHOCKS) in dataset
%
%    last change 02/14/2019
%
%    Code by Brianti, Marco e Cormun, Vito
%*************************************************************************%
clc
clear
close all
tic
% Technical Parameters
lags                = 4;             % Number of lags in the first step (deriving Ztilde)
leads               = 16;            % Number of leads in the first step (deriving Ztilde)
H                   = 20;            % IRFs horizon
lags_LP             = 1;             % Number of lags in the Local Projection
which_trend         = 'quadratic' ;  % BPfilter, HPfilter, linear, quadratic for Local Projection
which_Z             = '1';           % Which Forecast Revision: RGDP, NGDP, RCONS, INDPROD, RINV
which_shock         = {'Sentiment'}; % Tech, News
diff_LP             = 0;             % LP in levels or differences
nPC                 = 3;             % Number of Principal Components
norm_SHOCK          = 1;             % Divide shock over its own variance
printIRFs           = 0;             % Print IRFs
printVD             = 0;             % Print Variance Decompositions
nsimul              = 2000;          % number of simulations for bootstrap

% Define Dependent Variables
varlist          = {'SpreadBond','SpreadBankRate','VXO','ChicagoFedIndex','ChicagoFedIndex' ...
      'Vix'};

% Read main dataset
filename                    = 'main_file';
sheet                       = 'Sheet1';
range                       = 'B1:DP300';
do_truncation               = 0; %Do not truncate data. You will have many NaN
[dataset, var_names]        = read_data2(filename, sheet, range, do_truncation);
dataset                     = [dataset; NaN(leads,size(dataset,2))]; % Adding some NaN at the end for technical purposes

% Assess name to each variable
for i = 1:size(dataset,2)
      eval([var_names{i} ' = dataset(:,i);']);
end

%*************************************************************************%
%                                                                         %
%                     1st stage - Deriving sentiment                      %
%                                                                         %
%*************************************************************************%

%Building Zt - Forecast Revisions from SPF and Michigan Index
create_Z;

% Define Variables
[TFP_trunc, trunc1, trunc2] = truncate_data(TFP);
TFPBP                       = bpass(TFP_trunc,4,32);
TFPBP                       = [TFPBP; NaN(length(TFP) - length(TFPBP),1)];
dTFP                        = [NaN; diff(TFP)];
PC                          = [PC1 PC2 PC3 PC4 PC5 PC6 PC7 PC8 PC9];
PC                          = PC(:,1:nPC);
SHOCKS_NARRATIVE            = [MUNI1Y PDVMILY HAMILTON3YP RESID08 TAXNARRATIVE];

% Defibe dependent variable
eval(['Z = Z', which_Z,';']);
Y                           = Z;

% Define Regressors and Dependent Variable
X_contemporaneous           = [TFPBP SHOCKS_NARRATIVE];
X_lag                       = [TFPBP PC SHOCKS_NARRATIVE];
X_lead                      = TFPBP;

% Control Regression
[~, Zhat, Ztilde, regressor] = lead_lag_matrix_regression(Y,X_lead,...
      leads,X_lag,lags,X_contemporaneous);

%*************************************************************************%
%                                                                         %
%                      2nd stage - Local Projections                      %
%                                                                         %
%*************************************************************************%

% Create Inflation from Price Indexes
ninfl = 4;
PCEInflation    = create_inflation(PriceCPE,ninfl);
CPIInflation    = create_inflation(CPIInflation,ninfl);
CPIDurables     = create_inflation(CPIDurables,ninfl);
CPINonDurables  = create_inflation(CPINonDurables,ninfl);
CPIServices     = create_inflation(CPIServices,ninfl);

% Per capita adjustment
control_pop = 0; % Divide GDP, Cons, Hours, Investment over population
if control_pop == 1
      RealGDP                 = RealGDP - Population;
      RealCons                = RealCons - Population;
      RealInvestment          = RealInvestment - Population;
      HoursPerPerson          = HoursAll - Population;
      RealInventories         = RealInventories - Population;
      RealSales               = RealSales - Population;
else  
end

% Other Transformations
SP500                   = SP500 - GDPDefl;
SpreadBond              = MoodySpreadBaa - MoodySpreadAaa;
SpreadBankRate          = LoanPrime - TenYTreasury;
BankLeverage            = BanksTotLiabilities - BanksTotAssets;
CorpEqui2Assets         = NonFinEquity - NonFinTotAssets;
CorpDebt2Assets         = NonFinDebtSecurities - NonFinTotAssets;

% Matrix of dependen variables - All the variables are in log levels
for i = 1:length(varlist)
      dep_var(:,i) = eval(varlist{i});
end

% Choose the type of transformation
if diff_LP == 1
      dep_var = [nan(1,size(dep_var,2)); diff(dep_var)];
end

% Align timing with SHOCK
dep_var          = dep_var(1+lags:end-leads,:);
PC               = PC(1+lags:end-leads,:);

% Which shock to plot
for is = 1:length(which_shock)
      if strcmp(which_shock{is},'Sentiment') == 1
            SHOCK = Ztilde;
            fprintf('\n')
            disp('Sentiment Shock')
            fprintf('\n')
      elseif strcmp(which_shock{is},'Tech') == 1
            SHOCK = UnantTFPshock(1+lags:end-leads);
            fprintf('\n')
            disp('Unexpected Technology Shock')
            fprintf('\n')
      elseif strcmp(which_shock{is},'News') == 1
            SHOCK = BarskySimsNews(1+lags:end-leads);
            fprintf('\n')
            disp('Barsky and Sims News Shock')
            fprintf('\n')
      end
      IRFname = ['IRFs_',char(which_shock(is)),'Shock_lags',num2str(lags),'_','_leads',num2str(leads),'_lagsLP',num2str(lags_LP),'_trend',which_trend,'_Z',num2str(which_Z),'_diff',num2str(diff_LP),'_nPC',num2str(nPC),'.pdf'];
      VDname  = ['VD_',char(which_shock(is)),'Shock_lags',num2str(lags),'_','_leads',num2str(leads),'_lagsLP',num2str(lags_LP),'_trend',which_trend,'_Z',num2str(which_Z),'_diff',num2str(diff_LP),'_nPC',num2str(nPC)','.pdf'];
      
      % Normilize Variance of SHOCK
      if norm_SHOCK == 1
            sdSHOCK          = nanstd(SHOCK);
            SHOCK            = SHOCK/sdSHOCK;
      end
      
      %Initializating the loop
      for kk = 1:size(dep_var,2)
            % Define inputs for local_projection
            varnamekk                   = varlist{kk};
            disp(['  - Projecting ',varnamekk])
            fprintf('\n')
            depvarkk                    = dep_var(:,kk);
            [~, loc_start, loc_end]     = truncate_data([depvarkk SHOCK PC]);
            depvarkk                    = depvarkk(loc_start:loc_end);
            SHOCKkk                     = SHOCK(loc_start:loc_end);
            pckk                        = PC(loc_start:loc_end,:);
            % Run local_projection
            [IR{kk},res{kk},tuple{kk},VD{kk}] = ...
                  local_projection(depvarkk,pckk,SHOCKkk,lags_LP,H,which_trend);
            if diff_LP == 0
                  IRF(kk,:,is) = IR{kk};
            else
                  IRF(kk,:,is) = cumsum(IR{kk});
            end
            VDkk(kk,:) = VD{kk};
            % Initiate bootstrap
            tuplekk        = tuple{kk};
            for hh = 1:H
                  tuplekkhh = tuplekk{hh}; % Fix a specific horizon
                  Y                                = tuplekkhh(:,1);
                  X                                = tuplekkhh(:,2:end);
                  [Yboot, Xboot]                   = bb_bootstrap_LP(Y,X,nsimul,lags_LP);
                  for isimul = 1:nsimul
                        B                          = Xboot(:,:,isimul)'*Xboot(:,:,isimul)\...
                              (Xboot(:,:,isimul)'*Yboot(:,isimul));
                        IRF_boot(kk,hh,isimul,is)  = B(1);
                  end
            end
      end
      
      % Select upper and lower bands
      for kk = 1:size(dep_var,2)
            IRF_bootkk = IRF_boot(kk,:,:);
            if diff_LP == 0
                  IRF_boot(kk,:,:)  = IRF_bootkk;
            else
                  IRF_boot(kk,:,:)  = cumsum(IRF_bootkk,2);
            end
      end
      sig              = 0.05;
      sig2             = 0.16;
      for j = 1:size(dep_var,2)
            IRF_up(j,:)   = quantile(squeeze(IRF_boot(j,:,:,is))',1-sig);
            IRF_up2(j,:)  = quantile(squeeze(IRF_boot(j,:,:,is))',1-sig2);
            IRF_low(j,:)  = quantile(squeeze(IRF_boot(j,:,:,is))',sig);
            IRF_low2(j,:) = quantile(squeeze(IRF_boot(j,:,:,is))',sig2);
      end
      
      % Plot IRFs
      plot_IRF(varlist,IRF_low,IRF_low2,IRF_up,IRF_up2,IRF(:,:,is),H,printIRFs,IRFname); %change this function
      % Plot VD
      plot_IRF(varlist,VDkk,VDkk,VDkk,VDkk,VDkk,H,printVD,VDname)
end
close
% Technical Parameters
tech_info_table;

return


%*************************************************************************%
%                                                                         %
%                        Test Cyclicality - Canova                        %
%                                                                         %
%*************************************************************************%

% Simulate AR(1), Estimate IRFs via LP, Generate Spectral Density
rho             = 0;    % rho = 0, Hnull: flat spectral density, otherwise rho should be estimated from data as im BG
sigm            = 1;    % variance of disturbances (shocks)
T               = 1000; % Asyntotic (Maybe should be the same length) !!!
show_fig_AR_LP  = 1;
show_fig_AR_SD  = 1;
[IRF_AR,IRF_boot_AR] = generate_AR1_LP_IRF(rho,sigm,T,H,nsimul,sig,sig2,show_fig_AR_LP);
% Generate AR(1) Spectral Density
[SD_AR(:,1),SD_AR_UP(:,1),SD_AR_LOW(:,1), ...
      SD_AR_UP2(:,1),SD_AR_LOW2(:,1),SD_AR_MED(:,1),SD_AR_boot,period] ...
      = spectral_density_MA(IRF_AR,IRF_boot_AR,sig,sig2,show_fig_AR_SD);

%Generate Empirical Spectral Density
show_fig_SD  = 1;
for is = 1:length(which_shock)
      disp([which_shock{is}, ' Shock'])
      fprintf('\n')
      for iv = 1:length(varlist)
            disp(['Variable ',varlist{iv}])
            fprintf('\n')
            [SD(:,iv,is),SD_UP(:,iv,is),SD_LOW(:,iv,is), ...
                  SD_UP2(:,iv,is),SD_LOW2(:,iv,is), ...
                  SD_MED(:,iv,is), SD_boot(:,:,iv,is), ~] ...
                  = spectral_density_MA(IRF(iv,:,is),IRF_boot(iv,:,:,is),...
                  sig,sig2,show_fig_SD);
      end
end

%Compute average spectral density, D1, around the peak  and average
%spectral density around the trough, D2
lpeak_low    = 24; %should be adjusted with steps and IRF horizon
lpeak_up     = 26;
ltrough_low  = 58;
ltrough_up   = 60;
for iv = 1:length(varlist)
      for is = 1:length(which_shock)
            pval(is,iv) = test_canova_peak_sdensity(lpeak_low,lpeak_up,ltrough_low,ltrough_up,...
                  SD_boot(:,:,iv,is),SD_AR,period,nsimul);
      end
end
tech_info_test;
toc
